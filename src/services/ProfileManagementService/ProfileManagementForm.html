<style>
    /*
    These styles are specific to the profile form and will work in conjunction
    with the base styles and responsive classes provided by _Header.html.
    */

    /* Base styles for profile elements */
    p {
      font-size: 1rem;
      margin-bottom: 0.625rem;
    }

    label {
      font-size: 1rem;
      text-align: right;
    }

    input[type="text"],
    input[type="email"] {
      font-size: 1rem;
      padding: 0.5rem;
    }

    .profile-row {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      /* Desktop/Tablet columns */
      gap: 0.625rem;
      margin-bottom: 0.625rem;
      align-items: center;
    }

    .profile-row.header-row {
      display: grid;
    }

    .directory-checkbox-wrapper {
      display: flex;
      /* For centering the checkbox/label on desktop */
      justify-content: center;
      align-items: center;
    }

    .directory-label-mobile {
      display: none;
      /* Hide this on desktop/tablet */
    }

    .button-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      /* Center buttons horizontally */
      margin-top: 10px;
    }

    .button-container button {
      padding: 0.625rem 1.25rem;
      /* Use rem for padding */
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      /* Base font size */
      transition: background-color 0.3s ease;
      text-align: center;
      /* Added to explicitly center button text */
    }

    .button-container button:hover:not(:disabled) {
      background-color: #0056b3;
    }

    .button-container button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    /* Message display area styling */
    /* This overrides the .message text-align: center from _Header.html */
    #submissionMessage {
      text-align: left !important; /* Important to override the .message class from header */
      margin-top: 0.625rem; /* Matches .message margin from _Header.html */
      padding: 10px; /* Added for visual separation */
      border-radius: 4px; /* Added for visual separation */
      display: none; /* Hidden by default */
      font-size: 0.9rem; /* Matches .message font-size from _Header.html */
    }

    /* --- Responsive Styles (Applied based on classes on <html> from _Header.html's JS) --- */

    /* For Tablets: Styles apply when html has 'is-tablet' class */
    html.is-tablet .profile-row label {
      font-size: 1rem; /* Default size for tablet */
    }
    html.is-tablet input[type="text"],
    html.is-tablet input[type="email"] {
      font-size: 1rem; /* Default size for tablet */
    }
    html.is-tablet .button-container button {
      font-size: 1rem; /* Default size for tablet */
    }

    /* For Mobile Phones (Portrait & Landscape): Styles apply when html has 'is-mobile-portrait' or 'is-mobile-landscape' class */
    html.is-mobile-portrait p,
    html.is-mobile-landscape p {
      font-size: 1.125rem;
      text-align: left;
    }

    /* Mobile: Adapt .profile-row for a more compact column layout */
    html.is-mobile-portrait .profile-row,
    html.is-mobile-landscape .profile-row {
      display: grid;
      grid-template-columns: 0.8fr 2fr 0.5fr;
      /* Tuned proportions for mobile columns */
      gap: 0.4rem;
      /* Slightly reduced gap for mobile compactness */
      margin-bottom: 0.6rem;
      /* Slightly reduced margin */
      align-items: center;
    }

    /* Mobile: Ensure labels (First Name, etc.) are right-aligned in their column */
    html.is-mobile-portrait .profile-row label,
    html.is-mobile-landscape .profile-row label {
      grid-column: 1;
      text-align: right;
      font-size: 1.125rem;
      padding-right: 0;
      align-self: center;
      justify-self: end;
    }

    /* Mobile: Input fields (First Name, etc.) */
    html.is-mobile-portrait input[type="text"],
    html.is-mobile-portrait input[type="email"],
    html.is-mobile-landscape input[type="text"],
    html.is-mobile-landscape input[type="email"] {
      font-size: 1.125rem;
      grid-column: 2;
      width: 100%;
      justify-self: start;
      padding: 0.5rem;
      box-sizing: border-box;
    }

    /* Mobile: Header Row (make visible again) */
    html.is-mobile-portrait .profile-row.header-row,
    html.is-mobile-landscape .profile-row.header-row {
      display: grid;
      grid-template-columns: 0.8fr 2fr 0.5fr;
      gap: 0.4rem;
      font-weight: bold;
      margin-bottom: 0.4rem;
    }

    html.is-mobile-portrait .profile-row.header-row label,
    html.is-mobile-landscape .profile-row.header-row label {
      grid-column: 3;
      text-align: center;
      justify-self: center;
      font-size: 1.125rem;
      padding-right: 0;
    }

    /* Mobile: In Directory Checkbox Wrapper - Adapt for column layout */
    html.is-mobile-portrait .directory-checkbox-wrapper,
    html.is-mobile-landscape .directory-checkbox-wrapper {
      grid-column: 3;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%;
    }

    /* Mobile: Hide the mobile-specific label, as we're now using columns */
    html.is-mobile-portrait .directory-label-mobile,
    html.is-mobile-landscape .directory-label-mobile {
      display: none;
    }

    /* Mobile: Ensure the actual checkbox is styled within its wrapper */
    html.is-mobile-portrait .profile-row .directory-checkbox-wrapper input[type="checkbox"],
    html.is-mobile-landscape .profile-row .directory-checkbox-wrapper input[type="checkbox"] {
      margin: 0;
      padding: 0;
    }

    /* Mobile: button container and buttons */
    html.is-mobile-portrait .button-container,
    html.is-mobile-landscape .button-container {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
      margin-left: 0;
      margin-right: auto;
      width: 100%;
    }

    html.is-mobile-portrait .button-container button,
    html.is-mobile-landscape .button-container button {
      font-size: 1.125rem;
      padding: 0.75rem 1.5rem;
      width: 100%;
      box-sizing: border-box;
    }

    /* Mobile adjustments for the message div */
    html.is-mobile-portrait #submissionMessage,
    html.is-mobile-landscape #submissionMessage {
      font-size: 1rem; /* Adjusting as per _Header's mobile .message font-size */
      padding: 0.75rem; /* Larger padding for readability */
    }
  </style>
</head>

<body>
  <h2>SCCCC Member Profile</h2>
  <p>View and update your membership profile below.</p>

  <form id="profileForm">
    <!-- Membership Information Section (Read-Only) -->
    <h3>Membership Information</h3>
    <div class="profile-row">
      <label>Status:</label>
      <input type="text" value="<?= profile.Status ?>" disabled>
      <div></div>
    </div>

    <div class="profile-row">
      <label>Joined:</label>
      <input type="text" value="<?= profile.JoinedFormatted || '' ?>" disabled>
      <div></div>
    </div>

    <div class="profile-row">
      <label>Expires:</label>
      <input type="text" value="<?= profile.ExpiresFormatted || '' ?>" disabled>
      <div></div>
    </div>

    <? if (profile.RenewedOnFormatted) { ?>
    <div class="profile-row">
      <label>Renewed On:</label>
      <input type="text" value="<?= profile.RenewedOnFormatted ?>" disabled>
      <div></div>
    </div>
    <? } ?>

    <!-- Contact Information Section (Editable) -->
    <h3 style="margin-top: 1.5rem;">Contact Information</h3>
    <p style="margin-bottom: 1rem;"><em>Email changes require additional security steps - use the Email Change Service.</em></p>

    <div class="profile-row">
      <label for="email">Email:</label>
      <input type="text" id="email" name="Email" value="<?= profile.Email ?>" disabled>
      <div></div>
    </div>

    <div class="profile-row">
      <label for="first">First Name: <span style="color: red;">*</span></label>
      <input type="text" id="first" name="First" value="<?= profile.First ?>" required
        pattern="^[A-Za-z0-9\s-'.]+$"
        title="First Name must be non-empty and can contain letters, numbers, spaces, hyphens, apostrophes, or periods.">
      <div></div>
    </div>

    <div class="profile-row">
      <label for="last">Last Name: <span style="color: red;">*</span></label>
      <input type="text" id="last" name="Last" value="<?= profile.Last ?>" required
        pattern="^[A-Za-z0-9\s-'.]+$"
        title="Last Name must be non-empty and can contain letters, numbers, spaces, hyphens, apostrophes, or periods.">
      <div></div>
    </div>

    <div class="profile-row">
      <label for="phone">Phone: <span style="color: red;">*</span></label>
      <input type="text" id="phone" name="Phone" value="<?= profile.Phone ?>" required
        pattern="^\(\d{3}\) \d{3}-\d{4}$" title="Phone must match (123) 123-1234 format">
      <div></div>
    </div>

    <!-- Directory Sharing Section -->
    <h3 style="margin-top: 1.5rem;">Directory Sharing Preferences</h3>
    <p style="margin-bottom: 1rem;">Choose which information to share in the member directory:</p>

    <div class="profile-row">
      <label for="namePublic">Share Name:</label>
      <div style="display: flex; align-items: center;">
        <input type="checkbox" id="namePublic" name="Directory Share Name" <?= profile['Directory Share Name'] ? 'checked' : '' ?>>
        <span style="margin-left: 0.5rem;">Show my name in the directory</span>
      </div>
      <div></div>
    </div>

    <div class="profile-row">
      <label for="emailPublic">Share Email:</label>
      <div style="display: flex; align-items: center;">
        <input type="checkbox" id="emailPublic" name="Directory Share Email" <?= profile['Directory Share Email'] ? 'checked' : '' ?>>
        <span style="margin-left: 0.5rem;">Show my email in the directory</span>
      </div>
      <div></div>
    </div>

    <div class="profile-row">
      <label for="phonePublic">Share Phone:</label>
      <div style="display: flex; align-items: center;">
        <input type="checkbox" id="phonePublic" name="Directory Share Phone" <?= profile['Directory Share Phone'] ? 'checked' : '' ?>>
        <span style="margin-left: 0.5rem;">Show my phone in the directory</span>
      </div>
      <div></div>
    </div>

    <div class="button-container">
      <button type="submit" id="applyBtn" disabled>Apply</button>
      <button type="button" id="resetBtn">Reset</button>
    </div>

    <div id="submissionMessage" class="message"></div>
  </form>

  <script>
    const profileForm = document.getElementById('profileForm');
    const applyBtn = document.getElementById('applyBtn');
    const firstInput = document.getElementById('first');
    const lastInput = document.getElementById('last');
    const phoneInput = document.getElementById('phone');
    const namePublicCheckbox = document.getElementById('namePublic');
    const phonePublicCheckbox = document.getElementById('phonePublic');
    const emailPublicCheckbox = document.getElementById('emailPublic');
    const submissionMessage = document.getElementById('submissionMessage');

    const originalProfileData = JSON.parse('<?= JSON.stringify(profile) ?>');

    const originalData = {
      First: originalProfileData.First,
      Last: originalProfileData.Last,
      Phone: originalProfileData.Phone,
      'Directory Share Name': originalProfileData['Directory Share Name'],
      'Directory Share Phone': originalProfileData['Directory Share Phone'],
      'Directory Share Email': originalProfileData['Directory Share Email']
    };

    let updatedProfile = {
      ...originalData
    }; // Initialize updatedProfile object with original data

    function enableAllButEmail() {
      enableForm(profileForm, ['email']);
      // Extra safeguard: explicitly ensure email stays disabled
      document.getElementById('email').disabled = true;
    }
    
    function changesMade() {
      const currentUpdatedProfile = {
        First: firstInput.value,
        Last: lastInput.value,
        Phone: phoneInput.value,
        'Directory Share Name': namePublicCheckbox.checked,
        'Directory Share Phone': phonePublicCheckbox.checked,
        'Directory Share Email': emailPublicCheckbox.checked
      };
      // Compare the current form state with the original data to detect changes
      return JSON.stringify(originalData) !== JSON.stringify(currentUpdatedProfile);
    }

    function allInputsValid() {
      // Check that all required fields have non-empty trimmed values
      const firstValue = firstInput.value.trim();
      const lastValue = lastInput.value.trim();
      const phoneValue = phoneInput.value.trim();
      
      // All fields must have non-empty values
      if (firstValue === '' || lastValue === '' || phoneValue === '') {
        console.log('Validation failed: empty field detected', {
          first: firstValue === '',
          last: lastValue === '',
          phone: phoneValue === ''
        });
        return false;
      }
      
      // Additionally check HTML5 validation (pattern matching)
      const firstValid = firstInput.checkValidity();
      const lastValid = lastInput.checkValidity();
      const phoneValid = phoneInput.checkValidity();
      
      console.log('Field validation:', { firstValid, lastValid, phoneValid });
      
      return firstValid && lastValid && phoneValid;
    }
    
    // Format phone number to (NNN) NNN-NNNN
    function formatPhoneNumber(value) {
      console.log('formatPhoneNumber called with:', value);
      // Remove all non-digit characters
      const digits = value.replace(/\D/g, '');
      
      // Only format if we have digits
      let formatted = '';
      if (digits.length === 0) {
        formatted = '';
      } else if (digits.length <= 3) {
        formatted = `(${digits}`;
      } else if (digits.length <= 6) {
        formatted = `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
      } else {
        formatted = `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 10)}`;
      }
      
      console.log('formatPhoneNumber returning:', formatted);
      return formatted;
    }

    function updateApplyButtonState() {
      const hasChanges = changesMade();
      const isValid = allInputsValid();
      console.log('updateApplyButtonState:', { hasChanges, isValid });
      // The "Apply" button is enabled ONLY if changes have been made AND all required inputs are valid
      applyBtn.disabled = !(hasChanges && isValid);
      console.log('Apply button disabled:', applyBtn.disabled);
    }

    function enableContactCheckboxes() {
      phonePublicCheckbox.disabled = false;
      emailPublicCheckbox.disabled = false;
    }

    function uncheckAndDisableContactCheckboxes() {
      phonePublicCheckbox.checked = false;
      emailPublicCheckbox.checked = false;
      phonePublicCheckbox.disabled = true;
      emailPublicCheckbox.disabled = true;
      updateApplyButtonState(); // Update button state after changing checkboxes
    }

    function updateCheckboxState() {
      // If name checkbox is checked, enable contact checkboxes.
      // Otherwise, uncheck and disable them.
      if (namePublicCheckbox.checked) {
        enableContactCheckboxes();
      } else {
        uncheckAndDisableContactCheckboxes();
      }
      updateApplyButtonState(); // Always update button state after checkbox logic
    }

    // Function to display messages using the .message classes
    function displayMessage(message, type) {
      submissionMessage.textContent = message;
      // Clear existing type classes, but keep the base 'message' class
      submissionMessage.classList.remove('success', 'error'); 
      submissionMessage.classList.add(type); // Add 'success' or 'error' class
      submissionMessage.style.display = 'block'; // Make visible
    }

    // Function to clear messages
    function clearMessage() {
      submissionMessage.textContent = '';
      submissionMessage.classList.remove('success', 'error'); // Clear only type classes
      submissionMessage.style.display = 'none'; // Hide
    }

    // Event Listeners for Checkboxes to handle state changes
    namePublicCheckbox.addEventListener('change', () => {
      clearMessage();
      updateCheckboxState(); // This will enable/disable contact checkboxes based on name status
      updateApplyButtonState();
    });
    
    phonePublicCheckbox.addEventListener('change', () => {
      clearMessage();
      // If checking phone, must also share name
      if (phonePublicCheckbox.checked && !namePublicCheckbox.checked) {
        namePublicCheckbox.checked = true;
        updateCheckboxState();
      }
      updateApplyButtonState();
    });
    
    emailPublicCheckbox.addEventListener('change', () => {
      clearMessage();
      // If checking email, must also share name
      if (emailPublicCheckbox.checked && !namePublicCheckbox.checked) {
        namePublicCheckbox.checked = true;
        updateCheckboxState();
      }
      updateApplyButtonState();
    });

    // Event Listeners for Text Inputs to detect changes, trigger validation, and clear message
    document.getElementById('first').addEventListener('input', () => {
      clearMessage();
      updateApplyButtonState();
    });
    document.getElementById('last').addEventListener('input', () => {
      clearMessage();
      updateApplyButtonState();
    });
    
    // Phone input with auto-formatting
    phoneInput.addEventListener('input', (e) => {
      console.log('Phone input event fired');
      clearMessage();
      const cursorPos = e.target.selectionStart;
      const oldValue = e.target.value;
      const oldLength = oldValue.length;
      console.log('Phone input - oldValue:', oldValue, 'cursor:', cursorPos);
      
      // Format the phone number
      const formatted = formatPhoneNumber(oldValue);
      e.target.value = formatted;
      
      // Adjust cursor position after formatting
      const newLength = formatted.length;
      const diff = newLength - oldLength;
      e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
      
      updateApplyButtonState();
    });
    
    // Handle paste events for phone number
    phoneInput.addEventListener('paste', (e) => {
      e.preventDefault();
      const pastedText = (e.clipboardData || window.clipboardData).getData('text');
      const formatted = formatPhoneNumber(pastedText);
      phoneInput.value = formatted;
      clearMessage();
      updateApplyButtonState();
    });

    // Event Listener for Form Submission
    profileForm.addEventListener('submit', function (event) {
      event.preventDefault(); // Crucial: Prevent default browser page reload behavior

      clearMessage(); // Clear any previous messages when a new submission starts

      // Although the browser's native validation for 'required' and 'pattern'
      // will have already run (preventing submission if invalid), these checks
      // act as a safeguard and ensure the button state is correctly managed.
      if (!allInputsValid() || !changesMade()) {
          console.warn("Form submitted with invalid inputs or no changes detected. This should not happen if button state is correct.");
          updateApplyButtonState(); // Re-evaluate and potentially re-disable if state was out of sync
          return;
      }

      // Prepare the updated profile data from current form state
      const currentUpdatedProfile = {
        First: firstInput.value,
        Last: lastInput.value,
        Phone: phoneInput.value,
        'Directory Share Name': namePublicCheckbox.checked,
        'Directory Share Phone': phonePublicCheckbox.checked,
        'Directory Share Email': emailPublicCheckbox.checked
      };

      // Disable the form to prevent multiple submissions or editing during the save
      disableForm(profileForm);

      // Call server-side updateProfile function using google.script.run
      google.script.run
        .withSuccessHandler(function (response) {
          // Re-enable the form after server responds
          if (response && response.success) {
            // If the server update was successful, update our 'originalData'
            // so `changesMade()` correctly detects future changes.
            Object.assign(originalData, currentUpdatedProfile);
            displayMessage("Profile updated successfully!", "success");
          } else {
            displayMessage("Error updating profile: " + (response && response.error ? response.error : 'Unknown error.'), "error");
          }
          enableAllButEmail(profileForm); // Re-enable the form after processing
          updateApplyButtonState(); // Re-enable or keep disabled based on new changes (if any)
        })
        .withFailureHandler(function (error) {
          // Handle server-side errors
          displayMessage("Server error updating profile: " + error.message, "error");
          enableAllButEmail(profileForm);
          updateApplyButtonState(); // Re-enable button on failure to allow user to retry
        })
        .updateProfile("<?= token ?>", currentUpdatedProfile); // Pass token and updated profile data
    });

    // Event Listener for Reset Button
    document.getElementById('resetBtn').addEventListener('click', function () {
      clearMessage();
      
      // Reset form fields to original cached data (loaded at page load)
      firstInput.value = originalData.First;
      lastInput.value = originalData.Last;
      phoneInput.value = originalData.Phone;
      namePublicCheckbox.checked = originalData['Directory Share Name'];
      phonePublicCheckbox.checked = originalData['Directory Share Phone'];
      emailPublicCheckbox.checked = originalData['Directory Share Email'];
      
      // Ensure email field stays disabled
      document.getElementById('email').disabled = true;
      
      // Re-enable form fields (except email)
      enableAllButEmail();
      
      // Update button and checkbox states after resetting
      updateCheckboxState();
      updateApplyButtonState();
      
      displayMessage("Profile reset to original values", "success");
      setTimeout(clearMessage, 3000);
    });

    /*
    The checkViewportAndApplyClasses function and its event listeners are
    assumed to be present in the _Header.html and apply classes to the <html> tag.
    Therefore, we do not include them here.
    */

    // Initial setup when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Set the initial state of the Apply button (disabled if no changes or invalid inputs)
      updateApplyButtonState();
      // Set the initial state of the contact checkboxes (enabled/disabled based on name checkbox)
      updateCheckboxState();
      // Ensure the message area is clear and hidden on initial load
      clearMessage(); 
    });
  </script>

  <a class="nav-back-link" onclick="navigateToHomePage()">‚Üê Back to Services</a>
</body>

</html>