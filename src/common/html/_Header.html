<!-- Purpose of <base target="_top">: It tells the browser that all relative links within the document should open in the topmost Browse context (i.e., the entire browser window), rather than staying within the iframe that might contain the web app. This prevents "frame busting" issues and ensures a consistent navigation experience. -->

<base target="_top">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    /* Base Styles (for Desktop) */
    html {
        font-size: 16px;
        /* Default/Desktop base font size - 1rem = 16px */
        box-sizing: border-box;
    }

    *,
    *::before,
    *::after {
        box-sizing: inherit;
        /* Inherit box-sizing globally */
    }

    body {
        font-family: sans-serif;
        display: flex;
        /* Flexbox for centering on desktop */
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        /* This might be tricky in a fixed-size iframe. Consider adjusting if centering issues arise. */
        margin: 0;
        box-sizing: border-box;
        /* Ensuring body also respects box-sizing */
        background-color: #FFFFE0;
        /* Light Yellow for Desktop */
    }

    .container {
        background-color: white;
        width: 25rem;
        /* 400px / 16px = 25rem */
        padding: 1.25rem;
        /* 20px / 16px = 1.25rem */
        border: 0.0625rem solid #ccc;
        /* 1px / 16px = 0.0625rem */
        border-radius: 0.5rem;
        /* 8px / 16px = 0.5rem */
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
        /* 0 4px 8px */
    }

    h2 {
        font-size: 1.8rem;
        /* Desktop h2: 1.8 * 16px = 28.8px */
        text-align: center;
        margin-top: 0;
        margin-bottom: 1.25rem;
        /* 20px / 16px = 1.25rem */
    }

    input[type=email],
    button {
        width: 100%;
        padding: 0.75rem 1.25rem;
        /* 12px 20px */
        margin-bottom: 0.625rem;
        /* 10px / 16px = 0.625rem */
        display: block;
        /* Ensures they stack */
        border: 0.0625rem solid #ccc;
        border-radius: 0.25rem;
        /* 4px / 16px = 0.25rem */
        font-size: 1rem;
        /* Base font size for inputs/buttons (1 * 16px = 16px) */
    }

    button {
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    button:hover:not(:disabled) {
        background-color: #007bff;
    }

    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }


    /* Style for disabled form visual feedback */
    .form-disabled {
        opacity: 0.7;
        /* Faded appearance */
        pointer-events: none;
        /* Prevents cursor events on the form wrapper */
    }

    /* Ensure disabled inputs/buttons still have their default disabled styles */
    .form-disabled input,
    .form-disabled button,
    .form-disabled select,
    .form-disabled textarea {
        cursor: not-allowed;
    }

    .message {
        margin-top: 0.625rem;
        /* 10px / 16px = 0.625rem */
        font-size: 0.9rem;
        /* 0.9 * 16px = 14.4px */
        text-align: center;
    }

    .success {
        color: #007bff;
    }

    .error {
        color: red;
    }

    /* Data Tables  Styles */
    #data-table {
        width: 100%;
        /* Ensure the table fills its container */
        border-collapse: collapse;
    }

    #data-table th,
    #data-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        /* Remove width: auto; */
    }

    #data-table th {
        background-color: #f2f2f2;
    }

    /* --- Responsive Styles (Applied by JavaScript classes on <html>) --- */

    /* Tablet Styles */
    html.is-tablet {
        /* Class now directly on HTML */
        font-size: 17px;
        /* Tablet base font: 1rem = 17px */
    }

    html.is-tablet body {
        /* Target body for background/layout */
        background-color: #ADD8E6;
        /* Light Blue for Tablet */
    }

    html.is-tablet .container {
        width: 80%;
        /* Wider on tablet, still centered */
        max-width: 37.5rem;
        /* 600px / 16px = 37.5rem (This max-width will now scale based on the 17px base) */
        padding: 1.5625rem;
        /* 25px / 17px = ~1.47rem */
    }

    html.is-tablet h2 {
        font-size: 2.0rem;
        /* Tablet h2: 2.0 * 17px = 34px (Larger than Desktop h2) */
    }

    /* Mobile Portrait Styles */
    html.is-mobile-portrait {
        /* Class now directly on HTML */
        font-size: 18px;
        /* Mobile Portrait base font: 1rem = 18px */
    }

    html.is-mobile-portrait body {
        /* Target body for background/layout */
        display: block;
        /* Override flex for mobile portrait layout */
        padding: 0.9375rem;
        /* 15px / 18px = ~0.83rem (relative to new 18px base) */
        background-color: #FFB6C1;
        /* Light Magenta for Mobile Portrait */
    }

    html.is-mobile-portrait .container {
        width: 95%;
        margin: 0 auto;
        /* Center container on mobile block layout */
        padding: 0.9375rem;
        /* 15px / 18px = ~0.83rem */
    }

    html.is-mobile-portrait h2 {
        font-size: 2.2rem;
        /* Mobile Portrait h2: 2.2 * 18px = 39.6px (Largest h2) */
        margin-bottom: 0.9375rem;
        /* 15px / 18px = ~0.83rem */
    }

    html.is-mobile-portrait input[type=email],
    html.is-mobile-portrait button {
        padding: 1rem;
        /* 18px / 18px = 1rem */
        font-size: 1.1rem;
        /* 1.1 * 18px = 19.8px */
    }

    html.is-mobile-portrait .message {
        font-size: 1rem;
        /* 1 * 18px = 18px */
        text-align: left;
    }

    /* Mobile Landscape Styles */
    html.is-mobile-landscape {
        /* Class now directly on HTML */
        font-size: 17.5px;
        /* A distinct base size for mobile landscape */
    }

    html.is-mobile-landscape body {
        /* Target body for background/layout */
        display: block;
        /* Typically block layout for wider content */
        padding: 0.8rem;
        /* Slightly less padding than portrait */
        background-color: #E0FFFF;
        /* Light Cyan for Mobile Landscape */
    }

    html.is-mobile-landscape .container {
        width: 90%;
        /* Wider than portrait, narrower than tablet */
        max-width: 50rem;
        /* Custom max-width for mobile landscape */
        margin: 0 auto;
        padding: 1rem;
    }

    html.is-mobile-landscape h2 {
        font-size: 2.1rem;
        /* 2.1 * 17.5px = 36.75px */
        text-align: center;
        margin-bottom: 1rem;
    }

    /* Input, button, message styles can inherit or be overridden here */

    /* Navigation links (Back to Services, etc.) */
    .nav-back-link {
        display: block;
        margin-top: 1.5rem;
        text-align: center;
        color: #007bff;
        cursor: pointer;
        text-decoration: underline;
        font-size: 0.95rem;
    }

    .nav-back-link:hover {
        color: #0056b3;
    }

    html.is-mobile-portrait .nav-back-link,
    html.is-mobile-landscape .nav-back-link {
        font-size: 1rem;
        margin-top: 1.25rem;
    }
</style>
<script>
    function checkViewportAndApplyClasses() {
        // Get the HTML element
        const htmlElement = document.documentElement; // This correctly targets <html>
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;
        const isPortrait = window.matchMedia('(orientation: portrait)').matches; // Robust orientation check

        // Your established breakpoints
        const breakpoints = JSON.parse("<?= JSON.stringify(breakpoints) ?>");
        const mobileBreakpoint = parseInt(breakpoints.mobile);
        const tabletMinBreakpoint = parseInt(breakpoints.tabletMin);
        const tabletMaxBreakpoint = parseInt(breakpoints.tabletMax);

        console.log('Device Screen Width (window.screen.width):', screenWidth);
        console.log('Device Screen Height (window.screen.height):', screenHeight);
        console.log('Is Portrait:', isPortrait);

        // Remove all previous responsive classes from HTML element
        htmlElement.classList.remove('is-mobile-portrait', 'is-mobile-landscape', 'is-tablet');

        if (screenWidth <= mobileBreakpoint) {
            // This is a "mobile-sized" device based on its screen width
            if (isPortrait) {
                htmlElement.classList.add('is-mobile-portrait');
                console.log('- Mobile Portrait');
            } else {
                htmlElement.classList.add('is-mobile-landscape');
                console.log('- Mobile Landscape');
            }
        } else if (screenWidth >= tabletMinBreakpoint && screenWidth <= tabletMaxBreakpoint) {
            // This is a "tablet-sized" device based on its screen width
            htmlElement.classList.add('is-tablet');
            console.log('- Tablet');
        } else {
            // Desktop device (screenWidth > tabletMaxBreakpoint) - relies on base styles
            console.log('- Desktop');
        }
    }

    /**
 * Disables all input, button, select, and textarea elements within a given form,
 * and optionally adds a CSS class for visual feedback.
 * Also prevents subsequent form submissions by stopping default behavior.
 * @param {HTMLElement} formElement The form to disable.
 */
    function disableForm(formElement) {
        if (!formElement) {
            console.warn("Attempted to disable a non-existent form element.");
            return;
        }

        // Disable all form control elements
        for (let i = 0; i < formElement.elements.length; i++) {
            const element = formElement.elements[i];
            // Check if the element is a standard form control that can be disabled
            if (element.tagName === 'INPUT' || element.tagName === 'BUTTON' ||
                element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') { //
                element.disabled = true; //
            }
        }

        // Add a class for visual styling
        formElement.classList.add('form-disabled');

        // Add a property to track if the form is disabled via this function
        formElement.dataset.customDisabled = 'true';
    }

    /**
     * Enables all input, button, select, and textarea elements within a given form,
     * and removes the visual disabled class.
     * @param {HTMLElement} formElement The form to enable.
     * @param {string[]} [exceptions=[]] An optional array of element IDs to skip enabling.
     */
    function enableForm(formElement, exceptions = []) {
        if (!formElement) {
            console.warn("Attempted to enable a non-existent form element.");
            return;
        }

        // Only enable if it was disabled by our custom function
        if (formElement.dataset.customDisabled === 'true') {
            for (let i = 0; i < formElement.elements.length; i++) {
                const element = formElement.elements[i];
                // Skip the element if its ID is in the exceptions array
                if (exceptions.includes(element.id)) {
                    continue;
                }

                if (element.tagName === 'INPUT' || element.tagName === 'BUTTON' ||
                    element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
                    element.disabled = false;
                }
            }
            formElement.classList.remove('form-disabled');
            delete formElement.dataset.customDisabled;
        }
    }

    /**
     * Navigate back to the services home page
     * Uses cached services from sessionStorage for instant navigation (no server call)
     */
    function navigateToHomePage() {
        let email = '';
        let cachedServices = null;
        
        try {
            email = sessionStorage.getItem('authenticatedEmail') || '';
            const cachedServicesJson = sessionStorage.getItem('cachedServices');
            if (cachedServicesJson) {
                cachedServices = JSON.parse(cachedServicesJson);
            }
        } catch (e) {
            console.warn('Could not read from sessionStorage:', e);
        }
        
        // If we have cached services, render them directly without a server call
        if (cachedServices && Array.isArray(cachedServices) && cachedServices.length > 0) {
            renderHomePageFromCache(email, cachedServices);
            return;
        }
        
        // Fallback to server call if no cached services
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            // Show loading indicator
            const container = document.querySelector('.container');
            if (container) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Loading services...</div>';
            }
            
            google.script.run
                .withSuccessHandler(function(htmlContent) {
                    document.open();
                    document.write(htmlContent);
                    document.close();
                })
                .withFailureHandler(function(error) {
                    if (container) {
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: red;">Error loading services: ' + error.message + '</div>';
                    }
                })
                .getHomePageContent(email);
        } else {
            console.error('google.script.run is not available');
        }
    }

    /**
     * Render the home page directly from cached services (no server call)
     */
    function renderHomePageFromCache(email, services) {
        // SVG icons for services
        const serviceIcons = {
            directory: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>',
            email: '<svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>',
            groups: '<svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>',
            profile: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM7.07 18.28c.43-.9 3.05-1.78 4.93-1.78s4.51.88 4.93 1.78C15.57 19.36 13.86 20 12 20s-3.57-.64-4.93-1.72zm11.29-1.45c-1.43-1.74-4.9-2.33-6.36-2.33s-4.93.59-6.36 2.33C4.62 15.49 4 13.82 4 12c0-4.41 3.59-8 8-8s8 3.59 8 8c0 1.82-.62 3.49-1.64 4.83zM12 6c-1.94 0-3.5 1.56-3.5 3.5S10.06 13 12 13s3.5-1.56 3.5-3.5S13.94 6 12 6zm0 5c-.83 0-1.5-.67-1.5-1.5S11.17 8 12 8s1.5.67 1.5 1.5S12.83 11 12 11z"/></svg>',
            voting: '<svg viewBox="0 0 24 24"><path d="M18 13h-.68l-2 2h1.91L19 17H5l1.78-2h2.05l-2-2H6l-3 3v4c0 1.1.89 2 1.99 2H19c1.1 0 2-.89 2-2v-4l-3-3zm-1-5.05l-4.95 4.95-3.54-3.54 4.95-4.95 3.54 3.54zm-4.24-5.66L6.39 8.66a.996.996 0 0 0 0 1.41l4.95 4.95c.39.39 1.02.39 1.41 0l6.36-6.36a.996.996 0 0 0 0-1.41L14.16 2.3c-.38-.4-1.01-.4-1.4-.01z"/></svg>'
        };

        // HTML escape function
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Build the service cards HTML
        const serviceCardsHtml = services.map(service => `
            <div class="service-card" onclick="loadServiceFromHomePage('${escapeHtml(service.id)}')" role="button" tabindex="0">
                <div class="service-icon">
                    ${serviceIcons[service.icon] || serviceIcons.profile}
                </div>
                <div class="service-info">
                    <h3 class="service-name">${escapeHtml(service.name)}</h3>
                    <p class="service-description">${escapeHtml(service.description)}</p>
                </div>
                <span class="service-arrow">â€º</span>
            </div>
        `).join('');

        // Replace container content with home page
        const container = document.querySelector('.container');
        if (container) {
            container.innerHTML = `
                <style>
                    .service-list { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
                    .service-card { display: flex; align-items: center; padding: 1rem; background-color: #f8f9fa; border: 0.0625rem solid #ddd; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; text-decoration: none; color: inherit; }
                    .service-card:hover { background-color: #e9ecef; border-color: #007bff; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.1); }
                    .service-icon { width: 3rem; height: 3rem; display: flex; align-items: center; justify-content: center; background-color: #007bff; border-radius: 0.5rem; margin-right: 1rem; flex-shrink: 0; }
                    .service-icon svg { width: 1.5rem; height: 1.5rem; fill: white; }
                    .service-info { flex: 1; }
                    .service-name { font-size: 1.1rem; font-weight: 600; margin: 0 0 0.25rem 0; color: #333; }
                    .service-description { font-size: 0.9rem; color: #666; margin: 0; }
                    .service-arrow { color: #999; font-size: 1.2rem; margin-left: 0.5rem; }
                    .welcome-header { text-align: center; margin-bottom: 1.5rem; }
                    .welcome-message { font-size: 0.9rem; color: #666; margin-top: 0.5rem; }
                    .sign-out-link { display: block; margin-top: 1.5rem; text-align: center; color: #666; font-size: 0.9rem; cursor: pointer; text-decoration: underline; }
                    .sign-out-link:hover { color: #007bff; }
                </style>
                <div class="welcome-header">
                    <h2>SCCCC Services</h2>
                    <p class="welcome-message">${email ? 'Signed in as ' + escapeHtml(email) : 'Welcome to SCCCC Services'}</p>
                </div>
                <div class="service-list">
                    ${serviceCardsHtml}
                </div>
                <a class="sign-out-link" onclick="handleSignOutFromCache()">Sign out</a>
            `;

            // Add keyboard navigation to service cards
            container.querySelectorAll('.service-card').forEach(card => {
                card.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        card.click();
                    }
                });
            });
        }
    }

    /**
     * Load a service from the cached home page view
     */
    function loadServiceFromHomePage(serviceId) {
        const container = document.querySelector('.container');
        if (container) {
            container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Loading ' + serviceId.replace('Service', ' Service') + '...</div>';
        }

        let email = '';
        try {
            email = sessionStorage.getItem('authenticatedEmail') || '';
        } catch (e) {
            console.warn('Could not read from sessionStorage:', e);
        }
        
        if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
                .withSuccessHandler(function(htmlContent) {
                    document.open();
                    document.write(htmlContent);
                    document.close();
                })
                .withFailureHandler(function(error) {
                    if (container) {
                        container.innerHTML = '<div style="text-align: center; padding: 2rem; color: red;">Error loading service: ' + error.message + '</div>';
                    }
                })
                .getServiceContent(email, serviceId);
        } else {
            if (container) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: red;">Error: google.script.run is not available.</div>';
            }
        }
    }

    /**
     * Handle sign out from the cached home page view
     */
    function handleSignOutFromCache() {
        try {
            sessionStorage.removeItem('authToken');
            sessionStorage.removeItem('authenticatedEmail');
            sessionStorage.removeItem('cachedServices');
        } catch (e) {
            console.warn('Could not clear sessionStorage:', e);
        }
        window.location.reload();
    }
    // Initial check on load
    checkViewportAndApplyClasses();
    // Re-check on window resize (for orientation changes)
    window.addEventListener('resize', checkViewportAndApplyClasses);
</script>