# Deploy to staging and run GAS verification
#
# Pushes code to the dev GAS project, creates a versioned staging deployment
# (or reuses existing "CI-Staging" deployment), then hits the web app's 
# ?verify=1 endpoint to run verifyAll().
#
# The staging deployment is versioned and publicly accessible (ANYONE_ANONYMOUS),
# unlike the @HEAD deployment which requires domain authentication.
#
# Required repository secrets (see docs/CI_SETUP.md):
#   CLASP_CREDENTIALS   - Contents of .clasp-credentials.json (OAuth token for clasp push/deploy)
#   CLASP_DEV_SCRIPT_ID - GAS script ID for the dev environment
#
# Required repository variable:
#   GAS_STAGING_DEPLOYMENT_URL - Full URL to the staging deployment /exec endpoint
#                                (update after first run with deployment ID from summary)
#
name: Deploy & Verify (Staging)

on:
  workflow_dispatch:  # Manual trigger
  pull_request:       # Run on PRs to verify GAS deployment before merge
    branches: [main]
  workflow_run:       # Auto-trigger after CI passes on main
    workflows: ['CI']
    types: [completed]
    branches: [main]

jobs:
  deploy-and-verify:
    runs-on: ubuntu-latest
    # Run for: manual trigger, PRs, or auto-trigger after CI passes on main
    if: >-
      ${{
        github.event_name == 'workflow_dispatch' ||
        github.event_name == 'pull_request' ||
        github.event.workflow_run.conclusion == 'success'
      }}
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Configure clasp credentials
        run: |
          echo '${{ secrets.CLASP_CREDENTIALS }}' > ~/.clasprc.json

      - name: Configure clasp project (dev)
        run: |
          echo '{"scriptId":"${{ secrets.CLASP_DEV_SCRIPT_ID }}","rootDir":"src"}' > .clasp.json

      - name: Push to GAS environment
        run: clasp push

      - name: Create version and deploy to staging
        run: |
          # Create a new version
          VERSION_OUTPUT=$(clasp version "CI deploy - $(git rev-parse --short HEAD) - $(date -u '+%Y-%m-%d %H:%M:%S UTC')")
          echo "$VERSION_OUTPUT"
          VERSION_NUM=$(echo "$VERSION_OUTPUT" | grep -oP '(?<=Created version )\d+')
          echo "Created version: $VERSION_NUM"

          # Get or create staging deployment
          DEPLOYMENTS=$(clasp deployments)
          if echo "$DEPLOYMENTS" | grep -q "CI-Staging"; then
            # Extract existing staging deployment ID
            STAGING_DEPLOY_ID=$(echo "$DEPLOYMENTS" | grep "CI-Staging" | awk '{print $2}')
            echo "Using existing staging deployment: $STAGING_DEPLOY_ID"
            clasp deploy --deploymentId "$STAGING_DEPLOY_ID" --versionNumber "$VERSION_NUM" --description "CI-Staging"
          else
            # Create new staging deployment
            echo "Creating new staging deployment..."
            DEPLOY_OUTPUT=$(clasp deploy --versionNumber "$VERSION_NUM" --description "CI-Staging")
            echo "$DEPLOY_OUTPUT"
            STAGING_DEPLOY_ID=$(echo "$DEPLOY_OUTPUT" | grep -oP 'AKfycb[a-zA-Z0-9_-]+')
            echo "Created new staging deployment: $STAGING_DEPLOY_ID"
          fi
          
          # Save deployment ID to outputs for next steps
          echo "STAGING_DEPLOYMENT_ID=$STAGING_DEPLOY_ID" >> $GITHUB_ENV

      - name: Wait for deployment propagation
        run: sleep 5

      - name: Run GAS verification via web app
        run: node scripts/run-gas-verification.js
        env:
          GAS_VERIFY_URL: ${{ vars.GAS_STAGING_DEPLOYMENT_URL }}

      - name: Summary
        if: always()
        run: |
          if [ -f gas-verification-results.json ]; then
            echo "## GAS Deployment Verification Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            node -e "
              const r = require('./gas-verification-results.json');
              console.log('| Metric | Value |');
              console.log('|--------|-------|');
              console.log('| Total checks | ' + r.total + ' |');
              console.log('| Passed | ' + r.passed + ' |');
              console.log('| Failed | ' + r.failed + ' |');
              console.log('| Timestamp | ' + r.timestamp + ' |');
              console.log('');
              if (r.failed > 0) {
                console.log('### Failed Checks');
                console.log('');
                r.checks.filter(c => !c.passed).forEach(c => {
                  console.log('- **' + c.category + '**: ' + c.name + ' — ' + c.error);
                });
              }
            " >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ No verification results file found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show deployment ID for reference
          if [ -n "$STAGING_DEPLOYMENT_ID" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Deployment Info" >> $GITHUB_STEP_SUMMARY
            echo "Staging Deployment ID: \`$STAGING_DEPLOYMENT_ID\`" >> $GITHUB_STEP_SUMMARY
          fi
